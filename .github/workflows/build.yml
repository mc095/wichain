name: Build WiChain for All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            artifact_name: wichain-windows
            artifact_ext: .msi
          - os: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            artifact_name: wichain-linux
            artifact_ext: .deb
          - os: macos-latest
            rust_target: x86_64-apple-darwin
            artifact_name: wichain-macos
            artifact_ext: .dmg

    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: NUKE all lockfiles and node_modules from repo
        shell: bash
        run: |
          echo "=== Nuking all npm artifacts ==="
          find wichain-backend -name "package-lock.json" -type f -delete 2>/dev/null || true
          find wichain-backend -name ".package-lock.json" -type f -delete 2>/dev/null || true
          find wichain-backend -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
          git rm --cached -r wichain-backend/node_modules 2>/dev/null || true
          git rm --cached wichain-backend/package-lock.json 2>/dev/null || true
          git rm --cached wichain-backend/frontend/package-lock.json 2>/dev/null || true
          echo "=== Cleanup complete ==="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: wichain-backend/src-tauri

      - name: Install Linux dependencies
        if: matrix.platform.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            build-essential \
            curl \
            wget \
            file

      - name: FORCE clean all npm files (Unix)
        if: runner.os != 'Windows'
        working-directory: wichain-backend
        run: |
          rm -rf package-lock.json node_modules .package-lock.json 2>/dev/null || true
          rm -rf frontend/package-lock.json frontend/node_modules frontend/.package-lock.json 2>/dev/null || true
          npm cache clean --force

      - name: FORCE clean all npm files (Windows)
        if: runner.os == 'Windows'
        working-directory: wichain-backend
        shell: pwsh
        run: |
          Remove-Item -Path "package-lock.json","node_modules",".package-lock.json" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "frontend/package-lock.json","frontend/node_modules","frontend/.package-lock.json" -Recurse -Force -ErrorAction SilentlyContinue
          npm cache clean --force

      - name: Install EXACT Tauri versions (2.8.0)
        working-directory: wichain-backend/frontend
        run: |
          npm install @tauri-apps/api@2.8.0 @tauri-apps/cli@2.8.0 --save-exact --force
          npm install

      - name: Verify Tauri versions (SUCCESS!)
        working-directory: wichain-backend/frontend
        shell: bash
        run: |
          echo "=== Installed Tauri versions ==="
          npm list @tauri-apps/api @tauri-apps/cli || true
          echo ""
          echo "=== Checking Rust Cargo.toml ==="
          cat ../src-tauri/Cargo.toml | grep "tauri =" || true
          echo ""
          echo "‚úÖ Proceeding with build..."

      - name: Build frontend
        working-directory: wichain-backend/frontend
        run: npm run build

      - name: Update Cargo dependencies
        working-directory: wichain-backend/src-tauri
        run: cargo update

      - name: Install Tauri CLI (cached)
        uses: baptiste0928/cargo-install@v3
        with:
          crate: tauri-cli
          version: '2.8.0'

      - name: Build Tauri app
        working-directory: wichain-backend/src-tauri
        run: cargo tauri build

      # Debug: show bundle contents (cross-platform)
      - name: Show bundle directory (debug)
        shell: bash
        run: |
          B="wichain-backend/src-tauri/target/release/bundle"
          echo "Listing: $B"
          if [ -d "$B" ]; then
            find "$B" -maxdepth 4 -type f -print || true
          else
            echo "$B does not exist"
          fi

      # Artifact detection & upload (Unix)
      - name: Check for build artifacts (Unix)
        if: runner.os != 'Windows'
        id: artifact-check-unix
        shell: bash
        run: |
          B="wichain-backend/src-tauri/target/release/bundle"
          if [ -d "$B" ] && [ "$(find "$B" -type f | wc -l)" -gt 0 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Found files:"
            find "$B" -type f -maxdepth 4 -print
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No artifacts found in $B"
          fi

      - name: Upload artifacts (Unix)
        if: runner.os != 'Windows' && steps.artifact-check-unix.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact_name }}-${{ github.ref_name }}
          path: wichain-backend/src-tauri/target/release/bundle/**

      # Artifact detection & upload (Windows)
      - name: Check for build artifacts (Windows)
        if: runner.os == 'Windows'
        id: artifact-check-win
        shell: pwsh
        run: |
          $bundle = "wichain-backend\src-tauri\target\release\bundle"
          if (Test-Path $bundle) {
            $files = Get-ChildItem -Path $bundle -Recurse -File -ErrorAction SilentlyContinue
            if ($files.Count -gt 0) {
              echo "found=true" >> $env:GITHUB_OUTPUT
              Write-Host "Found files:"
              $files | ForEach-Object { Write-Host $_.FullName }
            } else {
              echo "found=false" >> $env:GITHUB_OUTPUT
              Write-Host "No files inside $bundle"
            }
          } else {
            echo "found=false" >> $env:GITHUB_OUTPUT
            Write-Host "$bundle does not exist"
          }

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows' && steps.artifact-check-win.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact_name }}-${{ github.ref_name }}
          path: wichain-backend/src-tauri/target/release/bundle/**

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Display artifact structure (debug)
        run: |
          echo "Downloaded artifacts root:"
          if [ -d artifacts ]; then
            ls -R artifacts || true
          else
            echo "artifacts/ directory not found - no artifacts were downloaded."
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Be broad on the patterns so we pick up the uploaded artifact directories
          files: |
            artifacts/**/**/*.msi
            artifacts/**/**/*.deb
            artifacts/**/**/*.AppImage
            artifacts/**/**/*.dmg
          body: |
            # üéâ WiChain ${{ github.ref_name }}

            ## üì¶ Downloads

            ### Windows
            - **wichain_${{ github.ref_name }}_x64.msi** - Windows 10/11 installer (64-bit)

            ### Linux
            - **wichain_${{ github.ref_name }}_amd64.deb** - Debian/Ubuntu package
            - **wichain_${{ github.ref_name }}_amd64.AppImage** - Universal Linux binary (no install)

            ### macOS
            - **wichain_${{ github.ref_name }}_x64.dmg** - macOS Intel installer

            ## üöÄ Installation
            ### Windows
            1. Download the `.msi` file
            2. Double-click to install
            3. Follow the wizard

            ### Linux (DEB)
            ```bash
            sudo dpkg -i wichain_${{ github.ref_name }}_amd64.deb
            sudo apt-get install -f
            ```

            ### Linux (AppImage)
            ```bash
            chmod +x wichain_${{ github.ref_name }}_amd64.AppImage
            ./wichain_${{ github.ref_name }}_amd64.AppImage
            ```

            ### macOS
            1. Download the `.dmg` file
            2. Open the DMG
            3. Drag WiChain to Applications folder

            ## üìù What's New
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## üêõ Report Issues
            Found a bug? [Open an issue](https://github.com/${{ github.repository }}/issues/new)

            ---
            Built with ‚ù§Ô∏è using Tauri 2.8.0
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
